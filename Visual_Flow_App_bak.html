<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Flow - 企業法フロー図</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Mermaid 10.x -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; color: #333; }
        
        /* Navigation Bar */
        .nav-link { opacity: 0.7; transition: all 0.2s; padding: 0.5rem 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .nav-link:hover { opacity: 1; background-color: rgba(255,255,255,0.1); }
        .nav-link.active { opacity: 1; background-color: rgba(255,255,255,0.2); font-weight: bold; border: 1px solid rgba(255,255,255,0.3); }

        /* Diagram Styles */
        .process-node { border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fff; }
        /* Mermaidコンテナ: SVGが直接入るためflex等の調整 */
        .mermaid { 
            display: flex; 
            justify-content: center; 
            background: #f8fafc; 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
            min-height: 200px;
            overflow-x: auto; /* 横スクロール対応 */
        }

        /* 脳科学的強調スタイル */
        .highlight { 
            background: linear-gradient(transparent 60%, #fef08a 60%); /* 蛍光ペン風の下線 */
            font-weight: 700; 
            padding: 0 2px; 
            border-radius: 2px; 
        }
        strong { 
            color: #1e40af; /* 重要単語は濃い青で信頼感を演出 */
            font-weight: 700;
        }
        /* 孤立効果スタイル */
        .isolation-effect {
            border: 2px solid #ef4444; /* 赤枠 */
            background-color: #fef2f2; /* 赤背景 */
            padding: 0.75rem;
            margin-top: 0.8rem;
            margin-bottom: 0.8rem;
            border-radius: 0.5rem;
            position: relative;
            font-size: 0.95em;
        }
        .isolation-icon {
            position: absolute;
            top: -12px;
            left: 10px;
            background: #fff;
            padding: 0 5px;
            font-weight: bold;
            color: #ef4444;
            font-size: 0.8em;
            border: 1px solid #ef4444;
            border-radius: 4px;
        }

        .irac-label {
            font-weight: bold;
            color: #475569;
            display: inline-block;
            width: 80px;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header & Navigation -->
    <header class="bg-slate-800 text-white shadow-md flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-project-diagram text-blue-400"></i> Visual Flow
            </h1>
            <nav class="flex gap-2 text-sm">
                <a href="Structure_Navigator.html" class="nav-link"><i class="fas fa-list-ul"></i> 目次学習</a>
                <a href="Visual_Flow_App.html" class="nav-link active"><i class="fas fa-project-diagram"></i> フロー図解</a>
                <a href="flashcards.html" class="nav-link"><i class="fas fa-layer-group"></i> 暗記カード</a>
            </nav>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Settings Sidebar -->
        <div class="w-64 bg-gray-50 border-r border-gray-200 p-4 flex flex-col gap-4 overflow-y-auto">
            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                <label class="block text-xs font-bold text-gray-500 mb-1">CURRENT TOPIC</label>
                <div id="currentTopicDisplay" class="font-bold text-blue-800 text-sm mb-1">未選択</div>
                <div id="currentRankDisplay" class="text-xs text-gray-500">Rank -</div>
            </div>

            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                <label class="block text-xs font-bold text-gray-500 mb-2">API SETTINGS</label>
                <!-- Shared Key Indicator -->
                <div id="sharedKeyStatus" class="hidden text-xs text-green-600 mb-2 font-bold">
                    <i class="fas fa-link mr-1"></i>Navigator連携済み
                </div>
                
                <input type="password" id="apiKey" placeholder="Gemini API Key" class="w-full p-2 text-xs border rounded mb-2 bg-gray-50">
                <button onclick="generateFlow()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-xs transition">
                    <i class="fas fa-sync-alt mr-1"></i> 再生成
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-y-auto">
            <div id="loading" class="hidden flex flex-col items-center justify-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-500 animate-pulse">AIが構造を解析中...</p>
                <p class="text-xs text-gray-400 mt-2">論点: <span id="loadingTopic"></span></p>
                <p class="text-[10px] text-gray-400 mt-1">※正確性を期すため条文照合プロセスを実行中</p>
            </div>

            <div id="contentArea" class="hidden max-w-4xl mx-auto">
                <h2 id="flowTitle" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2"></h2>
                
                <div id="mermaidContainer" class="mb-8 overflow-x-auto">
                    <!-- Mermaid Diagram -->
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-search text-blue-500 mr-2"></i> IRAC分析</h3>
                        <div id="iracContent" class="text-sm text-gray-600 space-y-3"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> メタファー理解</h3>
                        <div id="metaphorContent" class="text-sm text-gray-600 leading-relaxed"></div>
                    </div>
                </div>
            </div>
            
            <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-project-diagram text-4xl mb-3"></i>
                <p>左側のメニューから生成を開始するか、<br>Navigatorから論点を選択してください。</p>
            </div>
        </div>
    </div>

    <script>
        // ① 【最重要】Mermaidの初期化設定 (iPhone/Safari対応 安定版)
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            securityLevel: 'strict', // loose -> strict
            flowchart: { 
                htmlLabels: false, // true -> false (これが重要)
                useMaxWidth: true
            }
        });

        // --- Init ---
        window.addEventListener('load', async () => {
            const topic = localStorage.getItem('gemini_tutor_topic');
            const rank = localStorage.getItem('gemini_tutor_rank');
            const sharedKey = localStorage.getItem('gemini_api_key');
            
            // Check Shared API Key
            if(sharedKey) {
                document.getElementById('apiKey').value = sharedKey;
                document.getElementById('sharedKeyStatus').classList.remove('hidden');
            }

            if (topic) {
                // UI Update
                document.getElementById('currentTopicDisplay').innerText = topic;
                document.getElementById('currentRankDisplay').innerText = rank ? `Rank ${rank}` : 'Rank -';
                document.getElementById('emptyState').classList.add('hidden');

                // 自動生成開始
                await generateFlow();
            }
        });

        // --- Mock Data for Demo ---
        function getMockData(topic) {
            return {
                mermaid: `graph TD\n A["${topic}の開始"] --> B{Check}\n B -->|Yes| C["有効"]\n B -->|No| D["無効/取消"]`, // セミコロンなし、改行あり
                irac: {
                    issue: `<strong>${topic}</strong>における<span class='highlight'>法的争点</span>は何か？`,
                    rule: "会社法は<strong>取引安全</strong>と<strong>株主保護</strong>の調和を図る。<br><div class='isolation-effect'><span class='isolation-icon'>⚠️ 注意</span>ここには試験で問われやすい例外やひっかけ論点が入ります（孤立効果）。</div>",
                    application: "本件特有の事情を考慮し適用する。",
                    conclusion: "原則として<span class='highlight'>有効</span>に扱われる。"
                },
                metaphor: `<strong>${topic}</strong>は「${topic}」という<span class='highlight'>建物</span>のようなものです。基礎（要件）がしっかりしていないと倒壊（無効）します。`
            };
        }

        // --- Logic ---
        async function generateFlow() {
            const topic = localStorage.getItem('gemini_tutor_topic') || document.getElementById('currentTopicDisplay').innerText;
            const apiKey = localStorage.getItem('gemini_api_key') || document.getElementById('apiKey').value;

            if (!topic || topic === "未選択") { 
                alert("論点が選択されていません。Navigatorから選択してください。"); 
                return; 
            }
            
            // Show Loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingTopic').innerText = topic;
            document.getElementById('contentArea').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            if (apiKey) {
                // Real API Call
                try {
                    // ② Mermaidコードの「安定ルール」を適用したプロンプト
                    const prompt = `
                    あなたは公認会計士試験「企業法」の講師です。
                    論点:「${topic}」について、初学者が直感的に理解できるフロー図と解説を作成してください。
                    
                    **【参照基準】**
                    回答は必ず以下の公式法令データに準拠してください。
                    名称: e-Gov法令検索
                    URL: https://elaws.e-gov.go.jp/
                    ※特に会社法（平成十七年法律第八十六号）の条文番号と文言を正確に引用すること。

                    **【脳科学的デザイン要件】**
                    解説文には以下のHTMLタグを使用してください。
                    1. **重要キーワード**: <strong>タグ
                    2. **核心的概念**: <span class='highlight'>タグ
                    3. **孤立効果**: <div class='isolation-effect'><span class='isolation-icon'>⚠️ 注意</span>内容</div>
                    ※重要: HTML属性は必ずシングルクォート(')を使用すること（例: class='highlight'）。
                    
                    **【Mermaid絶対安定ルール】**
                    1. **ノードID**: 英数字のみ（日本語禁止）。
                    2. **日本語ラベル**: 必ず ["ラベル"] の形式で書くこと。
                    3. **分岐ノード**: {} の中は英数字IDのみ（日本語禁止）。
                    4. **改行**: 各行は必ずJSONのエスケープ改行(\\n)で区切ること。
                    5. **禁止事項**: セミコロン(;)、style、classDefは使用しないこと。
                    6. **開始**: graph TD から必ず開始すること。
                    
                    **出力フォーマット (JSONのみ):**
                    {
                        "mermaid": "graph TD\\n A[\\"開始\\"] --> B{Dec1}\\n B -->|\\"Yes\\"| C[\\"有効\\"]\\n B -->|\\"No\\"| D[\\"無効\\"]",
                        "irac": {
                            "issue": "法的争点（HTMLタグ含む）",
                            "rule": "規範（HTMLタグ含む）",
                            "application": "あてはめ（HTMLタグ含む）",
                            "conclusion": "結論（HTMLタグ含む）"
                        },
                        "metaphor": "物理的メタファーを用いた簡潔な説明（HTMLタグ含む）"
                    }
                    `;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) {
                        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonStr);
                        await renderFlow(topic, result);
                    } else {
                        throw new Error("No data returned");
                    }

                } catch (e) {
                    console.error(e);
                    alert("AI生成に失敗、または構文エラーが発生しました。デモデータを表示します。\n" + e.message);
                    await renderFlow(topic, getMockData(topic));
                }
            } else {
                // Demo Mode
                setTimeout(async () => {
                    const data = getMockData(topic); 
                    await renderFlow(topic, data);
                }, 1000); // デモ用ウェイト
            }
        }

        async function renderFlow(title, data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('contentArea').classList.remove('hidden');

            document.getElementById('flowTitle').innerText = title;
            
            const mContainer = document.getElementById('mermaidContainer');
            mContainer.innerHTML = ''; // Clear previous content
            
            // ③ Mermaid描画処理を「render API」に変更する (安定版)
            // Mermaid divを作成
            const div = document.createElement('div');
            div.className = 'mermaid';
            mContainer.appendChild(div);

            try {
                // DOMを直接書き換える init ではなく、SVGを生成して挿入する render を使用
                // 一意なIDを生成
                const id = 'mermaid-svg-' + Date.now();
                const { svg } = await mermaid.render(id, data.mermaid);
                div.innerHTML = svg;
            } catch (e) {
                console.error("Mermaid Render Error:", e);
                mContainer.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded border border-red-200 text-center"><p class="font-bold"><i class="fas fa-exclamation-triangle"></i> 図解の描画に失敗しました</p><p class="text-sm mt-1">構文エラーの可能性があります。「再生成」をお試しください。</p></div><div class="mt-2 text-xs text-gray-400 overflow-auto max-h-32 border p-2">${data.mermaid}</div>`;
            }

            document.getElementById('iracContent').innerHTML = `
                <div><span class="irac-label">Issue:</span> ${data.irac.issue}</div>
                <div><span class="irac-label">Rule:</span> ${data.irac.rule}</div>
                <div><span class="irac-label">App:</span> ${data.irac.application}</div>
                <div><span class="irac-label">Conc:</span> ${data.irac.conclusion}</div>
            `;
            document.getElementById('metaphorContent').innerHTML = data.metaphor;
        }

    </script>
</body>
</html>